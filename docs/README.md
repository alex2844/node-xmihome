# node-xmihome

[![NPM Version](https://img.shields.io/npm/v/node-xmihome.svg)](https://www.npmjs.com/package/node-xmihome)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**Node.js библиотека для управления устройствами Xiaomi Mi Home.**

`node-xmihome` предоставляет простой и удобный интерфейс для взаимодействия с
различными устройствами умного дома Xiaomi Mi Home через Node.js. Библиотека
поддерживает несколько типов подключения, включая MiIO, Bluetooth и облако
Xiaomi, позволяя вам интегрировать устройства Xiaomi в ваши Node.js приложения
или Node-RED проекты.

## Возможности

* **Поддержка нескольких типов подключения:**
  * **MiIO:**  Прямое локальное управление через протокол MiIO (токен + IP-адрес).
  * **Bluetooth:**  Управление Bluetooth LE устройствами (MAC-адрес + шаблон).
  * **Облако Xiaomi:** Управление через облако Xiaomi (логин/пароль + ID устройства).
* **Автоматическое определение типа подключения:** Библиотека автоматически
определяет тип подключения для *отдельного* устройства на основе предоставленных
данных конфигурации.
* **Настраиваемое обнаружение устройств:**
  * Получение списка устройств из облака Xiaomi (при наличии учетных данных).
  * Поиск MiIO устройств в локальной сети.
  * Сканирование Bluetooth LE устройств.
  * **Выбор метода обнаружения:** Возможность указать, как именно искать устройства
  (`cloud`, `miio`, `bluetooth` или комбинированный поиск по умолчанию)
  через опцию `connectionType` в конфигурации.
* **Управление устройствами:**
  * Чтение и запись свойств устройств.
  * Подписка на уведомления об изменении свойств в реальном времени.
  * Поддержка различных типов свойств (boolean, integer, float, string и другие).
* **Динамическая поддержка устройств и расширяемость:**
  * Библиотека может взаимодействовать с **большинством устройств Xiaomi Mi
  Home**, даже если для них нет специального файла определения в `lib/devices/`.
  * Файлы в `lib/devices/` предоставляют **оптимизированную поддержку** для
  определенных моделей, включая понятные имена свойств и, при необходимости,
  специфическую логику управления.
  * Архитектура библиотеки позволяет **легко добавлять поддержку новых
  устройств** путем создания файлов определений в `lib/devices/` для улучшения
  взаимодействия и удобства использования.
* **Поддержка Bluetooth LE на Linux:** Включает в себя автоматическую установку
`dbus-next` и генерацию конфигурационного файла для пользователей Linux, чтобы
решить проблемы с правами доступа к Bluetooth.

## Установка

Для установки библиотеки `node-xmihome` используйте npm:

```bash
npm install node-xmihome

# bun install node-xmihome
# bun ./node_modules/node-xmihome/install.js
```

**Важно для пользователей Linux, использующих Bluetooth:**

При установке, библиотека автоматически проверит наличие Bluetooth адаптера и
установит `dbus-next` если это необходимо.

Если вы не являетесь пользователем root,  во время установки будет создан
конфигурационный файл Bluetooth (`xmihome_bluetooth.conf`) в директории
`node_modules/node-xmihome/`.

Для корректной работы Bluetooth LE функций, вам может потребоваться скопировать
этот файл в системную директорию D-Bus и перезапустить службу Bluetooth:

```bash
sudo cp node_modules/node-xmihome/xmihome_bluetooth.conf /etc/dbus-1/system.d/
sudo systemctl restart bluetooth
```

Это необходимо для предоставления вашему пользователю прав доступа к Bluetooth
сервисам через D-Bus.

## Использование

Вот простой пример использования библиотеки для подключения к устройству и
управления им:

```javascript
import { XiaomiMiHome } from 'node-xmihome';

async function main() {
  const miHome = new XiaomiMiHome({
    credentials: {
      username: process.env.XIAOMI_USERNAME,
      password: process.env.XIAOMI_PASSWORD,
      country: 'sg'
    },
    connectionType: 'bluetooth',
    logLevel: 'error'
  });

  try {
    const devices = await miHome.getDevices({
      timeout: 30000,
      findCallback: (device, devices) => {
        return true;
      }
    });
    console.log('Найденные устройства:', devices);

    if (devices.length === 0)
      throw new Error('Device not found');

    // Выберите устройство для управления
    const device = await miHome.getDevice(devices[0]);

    // Подключитесь к устройству (тип подключения определится автоматически)
    await device.connect();
    console.log(`Подключено к устройству "${device.getName()}" через: ${device.connectionType}`);

    // Получите текущие свойства устройства
    const properties = await device.getProperties();
    console.log('Текущие свойства:', properties);

    // Установите новое значение свойства
    if (!properties.on) {
      await device.setProperty('on', true);
      console.log('Устройство включено');
    }

    // Отключитесь от устройства
    await device.disconnect();
    console.log('Отключено от устройства');

  } catch (error) {
    console.error('Ошибка:', error);
  } finally {
    // Освобождаем ресурсы
    miHome.destroy();
  }
}

main();
```

**Конфигурация:**

При создании экземпляра `XiaomiMiHome` вы можете передать объект конфигурации.

* **`credentials` (объект, необязательно):**
Учетные данные для облачного подключения Xiaomi.
  * `username` (строка): Имя пользователя аккаунта Xiaomi.
  * `password` (строка): Пароль аккаунта Xiaomi.
  * `country` (строка): Регион аккаунта Xiaomi (например, 'ru', 'cn', 'us').
* **`devices` (массив объектов, необязательно):**
Массив объектов с информацией об устройствах. Используется для предоставления
статической информации об устройствах или для указания токенов для MiIO устройств.
  * `id` (строка): ID устройства в облаке Xiaomi (для облачного подключения).
  * `address` (строка): IP-адрес устройства (для MiIO подключения).
  * `token` (строка): Токен устройства (для MiIO подключения).
  * `mac` (строка): MAC-адрес устройства (для Bluetooth подключения).
  * `model` (строка): Модель устройства (например, 'deerma.humidifier.jsq2w').
  * `name` (строка, необязательно): Имя устройства (для удобства).
* **`connectionType` (строка, необязательно):** Определяет **способ обнаружения
устройств** при вызове `getDevices()` и **тип подключения по умолчанию** при
вызове `device.connect()` без явного указания типа.
  * **При вызове `getDevices()`:**
    * `'cloud'`: Искать устройства только в облаке Xiaomi (требуются `credentials`).
    * `'miio'`: Искать устройства только через MiIO в локальной сети.
    * `'bluetooth'`: Искать устройства только через Bluetooth.
    * *Не указан (по умолчанию):* Если есть `credentials`, ищет в облаке.
    Если `credentials` нет, выполняет комбинированный поиск MiIO + Bluetooth.
  * **При вызове `device.connect()` без аргумента:** Используется как
  предпочтительный тип подключения, если он соответствует данным устройства
  (например, если `connectionType: 'miio'`, то у устройства должны
  быть `address` и `token`).
* **`logLevel` (строка, необязательно, по умолчанию `'none'`):**
Подробнее см. раздел "Логирование".

**Документация:**

Более подробная документация по API библиотеки, классам и методам находится в
комментариях к коду.

## Устройства с оптимизированной поддержкой (частичный список)

Библиотека **способна взаимодействовать со многими устройствами Xiaomi Mi Home**,
используя стандартные протоколы MiIO, Bluetooth и облачный API.

Список ниже представляет устройства, для которых в библиотеке реализована
**оптимизированная поддержка** через файлы определений в `lib/devices/`.
Это означает, что для этих устройств:

* Предоставлены **понятные имена свойств**
(например, `power`, `temperature`, `fan_level` вместо `2/1`, `3/7`, `2/5`).
* Может быть реализована **специфическая логика управления** или обработки данных
(как, например, в `yunmi.kettle.js` для аутентификации чайника).

**Список устройств с оптимизированной поддержкой:**

* Увлажнители воздуха Xiaomi Smart Humidifier 2
* Датчики температуры и влажности Miaomiaoce Sensor HT.T8
* Умные чайники Mi Smart Kettle
* *... и другие устройства.*

**Как добавить поддержку новых устройств:**

Если ваше устройство Xiaomi Mi Home не входит в список устройств с
оптимизированной поддержкой, вы все равно можете попытаться управлять им,
используя `node-xmihome`.

Для **улучшения поддержки** и добавления понятных имен свойств для вашего
устройства, вы можете:

1. **Исследовать спецификацию вашего устройства:** Поищите информацию о MiIO
протоколе или Bluetooth GATT сервисах и характеристиках, которые использует
ваше устройство. [Miot-spec.org](https://miot-spec.org/) может быть полезным ресурсом.
2. **Создать файл определения устройства:** Создайте новый файл `.js` в директории
`lib/devices/`, основываясь на примере существующих файлов
(например, `deerma.humidifier.jsq2w.js`).
3. **Определить статические свойства:** Заполните `static name`, `static models`,
и `static properties` в соответствии со спецификацией вашего устройства.
4. **Отправить Pull Request:**  Если вы хотите поделиться своей работой с
сообществом, отправьте Pull Request на GitHub репозиторий `node-xmihome` с вашим
файлом определения устройства.

## Логирование

Библиотека `node-xmihome` использует два механизма для вывода логов:

1. **Переменная окружения `NODE_DEBUG`:**
    * Для вывода детальной отладочной информации установите переменную
    окружения `NODE_DEBUG`:

      ```bash
      export NODE_DEBUG=xmihome
      # или для Windows (cmd): set NODE_DEBUG=xmihome
      # или для Windows (PowerShell): $env:NODE_DEBUG='xmihome'
      ```

    * Это включит вывод всех уровней логов (`debug`, `info`, `warn`, `error`)
    через встроенный механизм `util.debuglog`. Сообщения будут иметь префикс с
    PID процесса и уровнем лога (например, `XMIHOME 12345: [DEBUG] Сообщение...`).

2. **Опция конструктора `logLevel`:**
    * Вы можете контролировать вывод логов через стандартную `console`
    (`.info`, `.warn`, `.error`), передав опцию `logLevel` в
    конструктор `XiaomiMiHome`:

      ```javascript
      const miHome = new XiaomiMiHome({
        logLevel: 'info'
      });
      ```

    * **`'none'` (по умолчанию):** Логи через `console` отключены.
    * **`'error'`:** Выводятся только ошибки (`console.error`).
    * **`'warn'`:** Выводятся ошибки и предупреждения (`console.error`, `console.warn`).
    * **`'info'`:** Выводятся ошибки, предупреждения и информационные сообщения
    (`console.error`, `console.warn`, `console.info`).
    * **`'debug'`:** Выводятся все уровни логов, включая отладочные
    (`console.error`, `console.warn`, `console.info`, `console.log`).

**Приоритет и дублирование:**

* Если установлен `NODE_DEBUG=xmihome`, логи **всегда** будут выводиться через
`util.debuglog`, независимо от значения `logLevel`.
* Логи через `console` (управляемые `logLevel`) выводятся **только если
`NODE_DEBUG=xmihome` не установлен**, чтобы избежать дублирования сообщений.

**Рекомендация:**

* Используйте `logLevel` (например, `'info'` или `'warn'`) для обычного
мониторинга работы в ваших приложениях.
* Используйте `NODE_DEBUG=xmihome` для детальной отладки при возникновении проблем.

## Лицензия

[MIT License](LICENSE)

## Автор

[alex2844](https://github.com/alex2844)

[Ссылка на репозиторий GitHub](https://github.com/alex2844/node-xmihome)

