# xmihome

[RU] | [[EN]](../../README.md)

**Node.js библиотека для управления устройствами Xiaomi Mi Home.**

`xmihome` предоставляет простой и удобный интерфейс для взаимодействия с
различными устройствами умного дома Xiaomi Mi Home через Node.js.
Библиотека поддерживает несколько типов подключения, включая MiIO,
Bluetooth и облако Xiaomi, позволяя вам интегрировать
устройства Xiaomi в ваши Node.js приложения.

Этот пакет является основной зависимостью для [`node-red-contrib-xmihome`](https://www.npmjs.com/package/node-red-contrib-xmihome).

## Возможности

* **Поддержка нескольких типов подключения:**
  * **MiIO:** Прямое локальное управление через протокол MiIO (токен + IP-адрес).
  * **Bluetooth:** Управление Bluetooth LE устройствами (MAC-адрес + модель).
  * **Облако Xiaomi:** Управление через облако Xiaomi (логин/пароль + ID устройства).
* **Автоматическое определение типа подключения:** Библиотека автоматически
определяет тип подключения для *отдельного* устройства на основе предоставленных
данных конфигурации.
* **Настраиваемое обнаружение устройств:**
  * Получение списка устройств из облака Xiaomi.
  * Поиск MiIO устройств в локальной сети.
  * Сканирование Bluetooth LE устройств.
* **Динамическая поддержка устройств и расширяемость:**
  * Библиотека может взаимодействовать с **большинством устройств Xiaomi Mi Home**,
  даже если для них нет специального файла определения.
  * Файлы определений предоставляют **оптимизированную поддержку** для определенных
  моделей, включая понятные имена свойств и специфическую логику.
  * Легко добавлять поддержку новых устройств.
* **Поддержка Bluetooth LE на Linux:** Включает в себя автоматическую установку
`dbus-next` и генерацию конфигурационного файла для решения проблем с правами
доступа к Bluetooth.

## Установка

```bash
npm install xmihome
```

**Важно для пользователей Linux, использующих Bluetooth:**

При установке, библиотека автоматически проверит наличие Bluetooth адаптера и
установит `dbus-next` если это необходимо.

Если вы не являетесь пользователем root,  во время установки будет создан
конфигурационный файл Bluetooth `xmihome_bluetooth.conf` в директории
`node_modules/xmihome/`.

Для корректной работы Bluetooth LE функций, вам может потребоваться скопировать
этот файл в системную директорию D-Bus и перезапустить службу:

```bash
sudo cp node_modules/xmihome/xmihome_bluetooth.conf /etc/dbus-1/system.d/
sudo systemctl restart bluetooth
```

## Использование

```javascript
import { XiaomiMiHome } from 'xmihome';

async function main() {
  const miHome = new XiaomiMiHome({
    credentials: {
      username: process.env.XIAOMI_USERNAME,
      password: process.env.XIAOMI_PASSWORD,
      country: 'sg'
    },
    connectionType: 'cloud',
    logLevel: 'error'
  });

  try {
    const devices = await miHome.getDevices({
      timeout: 30000,
      onDeviceFound: (device, devices, type) => {
        // Верните true, чтобы включить устройство, false, чтобы проигнорировать, или
        // объект { include?: boolean, stop?: boolean } для управления поиском.
        return true;
      }
    });
    console.log('Найденные устройства:', devices);

    if (devices.length === 0)
      throw new Error('Device not found');

    // Выберите устройство для управления
    const device = await miHome.getDevice(devices[0]);

    // Подключитесь к устройству (тип подключения определится автоматически)
    await device.connect();
    console.log(`Подключено к устройству "${device.getName()}" через: ${device.connectionType}`);

    // Получите текущие свойства устройства
    const properties = await device.getProperties();
    console.log('Текущие свойства:', properties);

    // Установите новое значение свойства
    if (!properties.on) {
      await device.setProperty('on', true);
      console.log('Устройство включено');
    }

    // Отключитесь от устройства
    await device.disconnect();
    console.log('Отключено от устройства');

  } catch (error) {
    console.error('Ошибка:', error);
  } finally {
    // Освобождаем ресурсы
    miHome.destroy();
  }
}

main();
```

## Конфигурация

Объект конфигурации, передаваемый в конструктор `XiaomiMiHome`, может содержать:

* **`credentials`:**
Учетные данные для облачного подключения Xiaomi.
  * `username` (строка): Имя пользователя аккаунта Xiaomi.
  * `password` (строка): Пароль аккаунта Xiaomi.
  * `country` (строка): Регион аккаунта Xiaomi (например, 'ru', 'cn', 'us').
* **`devices` (массив объектов):**
Массив объектов с информацией об устройствах. Используется для предоставления
статической информации об устройствах или для указания токенов для MiIO устройств.
  * `id` (строка): ID устройства в облаке Xiaomi (для облачного подключения).
  * `address` (строка): IP-адрес устройства (для MiIO подключения).
  * `token` (строка): Токен устройства (для MiIO подключения).
  * `mac` (строка): MAC-адрес устройства (для Bluetooth подключения).
  * `model` (строка): Модель устройства (например, 'deerma.humidifier.jsq2w').
  * `name` (строка, необязательно): Имя устройства (для удобства).
* **`connectionType` (строка):** Определяет **способ обнаружения
устройств** при вызове `getDevices()` и **тип подключения по умолчанию** при
вызове `device.connect()` без явного указания типа.
  * **При вызове `getDevices()`:**
    * `'cloud'`: Искать устройства только в облаке Xiaomi (требуются `credentials`).
    * `'miio'`: Искать устройства только через MiIO в локальной сети.
    * `'bluetooth'`: Искать устройства только через Bluetooth.
    * *Не указан (по умолчанию):* Если есть `credentials`, ищет в облаке.
    Если `credentials` нет, выполняет комбинированный поиск MiIO + Bluetooth.
  * **При вызове `device.connect()` без аргумента:** Используется как
  предпочтительный тип подключения, если он соответствует данным устройства
  (например, если `connectionType: 'miio'`, то у устройства должны
  быть `address` и `token`).
* **`logLevel`**:
Уровень логирования (`'none'`, `'error'`, `'warn'`, `'info'`, `'debug'`).

## API Справка

Подробную информацию о классах и методах смотрите в полной документации по API:

* [**XiaomiMiHome**](./api/XiaomiMiHome.md) - Основной класс для управления
подключениями и устройствами.
* [**Device**](./api/Device.md) - Базовый класс для всех устройств, предоставляющий
методы для подключения, получения/установки свойств и т.д.
* [**Miot**](./api/Miot.md) - Класс для работы с протоколами Cloud и MiIO.
* [**Bluetooth**](./api/Bluetooth.md) - Класс для работы с Bluetooth LE
на низком уровне.

## Как добавить поддержку новых устройств

Если ваше устройство Xiaomi Mi Home не входит в список устройств с
оптимизированной поддержкой, вы все равно можете попытаться управлять им,
используя `xmihome`.

Для **улучшения поддержки** и добавления понятных имен свойств для вашего
устройства, вы можете:

1. **Исследовать спецификацию вашего устройства:** Поищите информацию о MiIO
протоколе или Bluetooth GATT сервисах и характеристиках, которые использует
ваше устройство. [Miot-spec.org](https://miot-spec.org/) может быть полезным ресурсом.
2. **Создать файл определения устройства:** Создайте новый файл `.js` в директории
[`packages/devices/src/devices/`](../../../devices/src/devices/),
основываясь на примере существующих файлов (например, `deerma.humidifier.jsq2w.js`).
3. **Определить статические свойства:** Заполните `static name`, `static models`,
`static properties` и `static actions` в соответствии со спецификацией вашего устройства.
4. **Отправить Pull Request:**  Если вы хотите поделиться своей работой с
сообществом, отправьте Pull Request на GitHub репозиторий `xmihome` с вашим
файлом определения устройства.

## Логирование

Библиотека поддерживает два способа логирования:

1. **Переменная окружения `NODE_DEBUG=xmihome`** для детального вывода через `util.debuglog`.
2. **Опция конструктора `logLevel`** для вывода в `console`.
