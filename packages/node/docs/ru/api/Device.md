# Класс: Device

Базовый класс для всех устройств Xiaomi. Предоставляет унифицированный
интерфейс для подключения, управления свойствами и подписки на уведомления.

Экземпляры этого класса обычно создаются через метод
`XiaomiMiHome.getDevice()`.

## Статические методы

### `registerModels(models)`

Регистрирует классы устройств из пакета `xmihome-devices`, делая их
доступными для `findModel` и `create`.

**Параметры:**

| Имя      | Тип      | Описание                                                      |
| -------- | -------- | ------------------------------------------------------------- |
| `models` | `object` | Объект, где ключи - это модели, а значения - классы устройств. |

### `getModels()`

Получает список всех зарегистрированных моделей устройств.

**Возвращает:**

- `string[]`: Массив строк с моделями.

### `findModel(device)`

Находит подходящий класс для устройства на основе его `model` или `name`.

**Параметры:**

| Имя      | Тип      | Описание                          |
| -------- | -------- | --------------------------------- |
| `device` | `object` | Конфигурационный объект устройства. |

**Возвращает:**

- `typeof Device \| undefined`: Найденный класс устройства или `undefined`.

### `valid(device, model)`

Проверяет, соответствует ли конфигурация устройства конкретному классу модели.

**Параметры:**

| Имя      | Тип      | Описание                            |
| -------- | -------- | ----------------------------------- |
| `device` | `object` | Конфигурационный объект устройства. |
| `model`  | `class`  | Проверяемый класс устройства.       |

**Возвращает:**

- `boolean`: `true`, если соответствует, и `false` в противном случае.

### `create(device, client)`

Создает экземпляр нужного класса устройства (`Device` или его подкласс) на
основе модели. Если для модели нет специального класса, пытается
загрузить спецификацию из облака MiOT.

**Параметры:**

| Имя      | Тип            | Описание                          |
| -------- | -------------- | --------------------------------- |
| `device` | `object`       | Конфигурационный объект устройства. |
| `client` | `XiaomiMiHome` | Экземпляр основного клиента.       |

**Возвращает:**

- `Promise<Device>`: Промис, который разрешается экземпляром `Device`.

### `getDeviceId(device)`

Генерирует уникальный строковый идентификатор для экземпляра устройства
на основе его конфигурации.

**Параметры:**

| Имя      | Тип      | Описание                          |
| -------- | -------- | --------------------------------- |
| `device` | `object` | Конфигурационный объект устройства. |

**Возвращает:**

- `string`: Уникальный ключ для устройства.

### `getDeviceType(device, credentials)`

Определяет наиболее вероятный тип подключения (`miio`, `bluetooth`,
`cloud`) на основе доступных полей в конфигурации устройства.

**Параметры:**

| Имя           | Тип      | Описание                             |
| ------------- | -------- | ------------------------------------ |
| `device`      | `object` | Конфигурационный объект устройства.   |
| `credentials` | `object` | (Опционально) Учетные данные облака. |

**Возвращает:**

- `'miio' \| 'bluetooth' \| 'cloud' \| undefined`: Строка с типом подключения.

## Свойства

| Имя              | Тип       | Описание                                                          |
| ---------------- | --------- | ----------------------------------------------------------------- |
| `connectionType` | `string`  | Текущий тип подключения (`'miio'`, `'bluetooth'`, `'cloud'`).     |
| `isConnected`    | `boolean` | `true`, если устройство в данный момент подключено.               |
| `isConnecting`   | `boolean` | `true`, если устройство в процессе подключения.                   |
| `isReconnecting` | `boolean` | `true`, если устройство в процессе переподключения.                |
| `properties`     | `object`  | Определения всех свойств устройства.                              |
| `actions`        | `object`  | Определения всех действий устройства.                             |

## События

Экземпляры класса `Device` генерируют следующие события:

| Событие              | Данные               | Описание                                              |
| -------------------- | -------------------- | ----------------------------------------------------- |
| `connected`          | `string` (тип)       | Генерируется при успешном соединении.                 |
| `disconnect`         | -                    | Генерируется при разрыве соединения.                  |
| `reconnecting`       | `{ reason: string }` | Генерируется при начале авто-переподключения.         |
| `reconnect_failed`   | `{ attempts: num }`  | Генерируется при неудаче всех попыток переподключения.|
| `properties`         | `object`             | Генерируется при изменении свойств устройства.        |
| `external_disconnect`| `string` (причина)   | Генерируется при внешнем разрыве (D-Bus/сеть).        |

## Методы

### `connect(connectionType)`

Устанавливает соединение с устройством. Тип подключения определяется
автоматически, если не указан явно.

**Параметры:**

| Имя              | Тип      | Описание                                                             |
| ---------------- | -------- | -------------------------------------------------------------------- |
| `connectionType` | `string` | (Опционально) Предпочитаемый тип (`'miio'`, `'bluetooth'`, `'cloud'`).|

**Возвращает:**

- `Promise<void>`

### `disconnect()`

Разрывает соединение с устройством.

**Возвращает:**

- `Promise<void>`

### `getName()`

Получает имя устройства.

**Возвращает:**

- `string`: Имя устройства.

### `getModel()`

Получает идентификатор модели устройства.

**Возвращает:**

- `string`: Строка модели устройства.

### `getProperty(prop)`

Получает значение одного свойства.

**Параметры:**

| Имя    | Тип               | Описание                                      |
| ------ | ----------------- | --------------------------------------------- |
| `prop` | `string \| object` | Имя свойства или объект определения свойства. |

**Возвращает:**

- `Promise<any>`: Промис, который разрешается значением свойства.

### `getProperties(properties)`

Получает значения нескольких свойств.

**Параметры:**

| Имя          | Тип                    | Описание                                                             |
| ------------ | ---------------------- | -------------------------------------------------------------------- |
| `properties` | `(string \| object)[]` | (Опционально) Массив свойств для получения.                          |

**Возвращает:**

- `Promise<object>`: Промис, разрешающийся объектом `{ key: val }`.

### `setProperty(prop, value)`

Устанавливает значение для одного свойства.

**Параметры:**

| Имя     | Тип               | Описание                                      |
| ------- | ----------------- | --------------------------------------------- |
| `prop`  | `string \| object` | Имя свойства или объект определения свойства. |
| `value` | `any`             | Новое значение для свойства.                  |

**Возвращает:**

- `Promise<void>`

### `callAction(action, value)`

Вызывает определенное действие на устройстве.

**Параметры:**

| Имя      | Тип               | Описание                                     |
| -------- | ----------------- | -------------------------------------------- |
| `action` | `string \| object` | Имя действия или объект определения действия. |
| `value`  | `any[]`           | (Опционально) Массив параметров для действия. |

**Возвращает:**

- `Promise<any>`: Промис, разрешающийся результатом выполнения действия.

### `startNotify(prop, callback)`

Подписывается на уведомления об изменении значения свойства.

**Параметры:**

| Имя        | Тип               | Описание                                                     |
| ---------- | ----------------- | ------------------------------------------------------------ |
| `prop`     | `string \| object` | Имя или объект определения свойства для подписки.            |
| `callback` | `function`        | Функция, вызываемая с новым значением при изменении.         |

**Возвращает:**

- `Promise<void>`

### `stopNotify(prop)`

Отменяет подписку на уведомления для свойства.

**Параметры:**

| Имя    | Тип               | Описание                                                  |
| ------ | ----------------- | --------------------------------------------------------- |
| `prop` | `string \| object` | Имя или объект определения свойства для отписки.          |

**Возвращает:**

- `Promise<void>`

### `startMonitoring(callback)`

Запускает пассивный мониторинг рекламных пакетов (только Bluetooth).

**Параметры:**

| Имя        | Тип        | Описание                                                               |
| ---------- | ---------- | ---------------------------------------------------------------------- |
| `callback` | `function` | Функция, вызываемая с данными из рекламного пакета.                    |

**Возвращает:**

- `Promise<void>`

### `stopMonitoring()`

Останавливает пассивный мониторинг рекламных пакетов.

**Возвращает:**

- `Promise<void>`

### `auth()`

Выполняет специфичную для устройства логику аутентификации.

**Возвращает:**

- `Promise<void>`

